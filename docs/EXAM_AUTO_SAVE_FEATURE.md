# 考试页面自动保存功能

## 功能概述

新增了考试页面自动保存功能，允许考生在短时间关闭考试页面后仍然可以回到考试界面继续作答，确保考试的连续性和用户体验。

## 主要特性

### 1. 自动保存机制
- **答题自动保存**：每次选择或修改答案时，系统会自动保存当前状态
- **题目切换保存**：切换题目时自动保存当前答题进度
- **防抖机制**：避免频繁保存，提高性能（最小间隔3秒）

### 2. 页面状态监控
- **页面可见性检测**：当用户切换到其他标签页时自动保存
- **页面卸载保护**：浏览器关闭或刷新前自动保存并显示确认提示
- **离开警告**：在考试进行中离开页面时显示警告信息

### 3. 状态恢复
- **智能恢复**：重新打开考试页面时自动恢复之前的答题状态
- **时间同步**：根据离开时间自动调整剩余考试时间
- **有效期控制**：保存状态有效期为2小时，超时自动清理

### 4. 用户界面改进
- **保存状态指示器**：实时显示保存状态（已保存/保存中/保存失败）
- **友好提示**：在页面顶部显示自动保存功能说明
- **视觉反馈**：使用图标和颜色区分不同的保存状态

## 技术实现

### 数据存储
- 使用浏览器的 `localStorage` 存储考试状态
- 存储内容包括：
  - 会话ID
  - 当前答案数组
  - 当前题目索引
  - 剩余时间
  - 最后保存时间

### 事件监听
```typescript
// 页面可见性变化监听
document.addEventListener('visibilitychange', handleVisibilityChange);

// 页面卸载前监听
window.addEventListener('beforeunload', handleBeforeUnload);

// 页面完全卸载监听
window.addEventListener('unload', handleUnload);
```

### 状态恢复逻辑
```typescript
const restoreExamState = () => {
  const savedState = localStorage.getItem(`exam_state_${sessionId}`);
  if (savedState) {
    const examState = JSON.parse(savedState);
    // 检查保存时间有效性
    if (Date.now() - examState.lastSaved <= 2 * 60 * 60 * 1000) {
      // 恢复答案、题目位置和调整时间
      setAnswers(examState.answers);
      setCurrentQuestion(examState.currentQuestion);
      // 调整剩余时间
      const timePassed = Math.floor((Date.now() - examState.lastSaved) / 1000);
      setTimeLeft(Math.max(0, examState.timeLeft - timePassed));
    }
  }
};
```

## 使用场景

### 1. 临时离开
- 考生需要短暂离开电脑（如上厕所、接电话）
- 系统自动保存当前状态，回来后可以继续作答

### 2. 意外断线
- 网络暂时中断或浏览器崩溃
- 重新连接后可以恢复到离开时的状态

### 3. 多标签页操作
- 考生需要查看其他网页资料（如果考试允许）
- 切换标签页时自动保存状态

### 4. 设备切换
- 在同一浏览器中，可以在不同设备间继续考试
- 注意：需要在同一浏览器账户下同步 localStorage

## 用户操作指南

### 考生须知
1. **保存提示**：页面顶部会显示自动保存功能的说明
2. **状态指示**：答题时注意观察右上角的保存状态指示器
3. **离开确认**：离开页面时会出现确认对话框，提醒答题进度已保存
4. **时间提醒**：恢复考试时系统会自动调整剩余时间

### 管理员须知
1. **功能默认启用**：所有考试自动启用此功能，无需额外配置
2. **数据清理**：考试提交后会自动清理本地保存的状态
3. **监控建议**：建议提醒考生在重要考试中尽量避免频繁离开

## 兼容性说明

### 浏览器支持
- Chrome 5+
- Firefox 3.5+
- Safari 4+
- Edge (所有版本)
- IE 8+

### 存储限制
- localStorage 容量限制：通常为 5-10MB
- 单个考试状态占用：约 1-5KB
- 建议定期清理过期状态

## 安全考虑

### 数据安全
- 本地存储不包含题目正确答案
- 仅存储考生的答题选择和进度信息
- 考试结束后自动清理敏感数据

### 防作弊措施
- 保存状态包含时间戳，防止时间操控
- 状态恢复时会验证考试有效性
- 超时考试无法通过本地状态恢复

## 故障排除

### 常见问题

1. **状态未保存**
   - 检查浏览器是否禁用了 localStorage
   - 确认浏览器隐私模式设置
   - 查看浏览器控制台错误信息

2. **状态恢复失败**
   - 检查本地时间是否正确
   - 确认考试是否已超时
   - 清除浏览器缓存后重试

3. **时间计算异常**
   - 确保系统时间准确
   - 检查网络连接稳定性
   - 刷新页面重新同步时间

### 调试信息
开发模式下可以在浏览器控制台查看详细的保存和恢复日志：
```javascript
// 查看保存的状态
console.log(localStorage.getItem('exam_state_SESSION_ID'));

// 清除特定考试状态
localStorage.removeItem('exam_state_SESSION_ID');

// 清除所有考试状态
Object.keys(localStorage).forEach(key => {
  if (key.startsWith('exam_state_')) {
    localStorage.removeItem(key);
  }
});
```

## 更新日志

### v1.0.0 (2024-07-14)
- 初始版本发布
- 实现基本自动保存功能
- 添加状态恢复机制
- 增加用户界面提示
- 完善错误处理和兼容性

## 下一步计划

1. **服务端同步**：将状态同时保存到服务器，增强可靠性
2. **多设备支持**：支持跨设备继续考试
3. **高级分析**：添加考试行为分析和统计功能
4. **性能优化**：优化大量题目时的保存性能
