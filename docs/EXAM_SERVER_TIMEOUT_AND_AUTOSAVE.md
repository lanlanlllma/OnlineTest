# 考试服务端超时检测和自动保存功能

## 功能概述

为了确保考试系统的可靠性和公平性，新增了服务端超时检测和自动保存功能。这些功能可以在客户端网络不稳定或浏览器崩溃的情况下保护考试数据。

## 核心功能

### 1. 双重自动保存机制

#### 本地保存 (localStorage)
- **频率**: 答题时实时保存
- **触发条件**: 
  - 答题选择改变
  - 切换题目
  - 页面隐藏/显示
  - 页面卸载前
- **用途**: 快速恢复和网络故障备份

#### 服务端保存
- **频率**: 
  - 防抖保存：答题后10秒内最多保存一次
  - 定时保存：每30秒强制保存一次
  - 页面事件：页面隐藏、卸载时保存
- **API端点**: `POST /api/exam/save-progress`
- **保存内容**:
  - 当前答题状态 (`answers`)
  - 当前题目位置 (`currentQuestion`)
  - 剩余时间 (`timeLeft`)
  - 保存时间戳

### 2. 服务端超时检测

#### 检测机制
- **API端点**: `GET /api/exam` 和 `POST /api/exam/save-progress`
- **检测逻辑**: 比较当前时间与考试开始时间，超过 `timeLimit` 则触发超时
- **检测频率**: 
  - 每次保存答题状态时检测
  - 客户端每30秒主动检查服务端状态

#### 超时处理
当服务端检测到考试超时：
1. **立即更新考试状态**为 `expired`
2. **计算最终得分**（基于当前已提交的答案）
3. **返回410状态码**，通知客户端考试已过期
4. **自动提交**考试结果

### 3. 客户端同步机制

#### 状态同步
- **实时同步**: 每次答题变化后延迟同步到服务端
- **定期同步**: 每30秒强制同步，确保数据一致性
- **断线重连**: 网络恢复后自动同步最新状态

#### 超时响应
客户端收到服务端超时通知后：
1. **清理本地状态**
2. **显示超时提示**
3. **自动跳转**到结果页面
4. **阻止继续答题**

## 数据结构扩展

### ExamSession 类型扩展
```typescript
interface ExamSession {
  // ...existing fields...
  lastSaved?: Date;           // 最后保存时间
  progress?: {                // 进度跟踪
    currentQuestion: number;  // 当前题目
    timeLeft: number | null;  // 剩余时间
    answeredCount: number;    // 已答题数
  };
}
```

## API端点

### 保存进度
```
POST /api/exam/save-progress
```

**请求体**:
```json
{
  "sessionId": "exam_123456",
  "answers": [0, [1,2], -1, 2],
  "currentQuestion": 2,
  "timeLeft": 1800
}
```

**响应**:
```json
{
  "success": true,
  "message": "进度已保存",
  "progress": {
    "currentQuestion": 2,
    "timeLeft": 1800,
    "answeredCount": 3
  }
}
```

**超时响应** (410):
```json
{
  "error": "考试时间已到",
  "timeExpired": true
}
```

### 获取进度
```
GET /api/exam/save-progress?sessionId=exam_123456
```

**响应**:
```json
{
  "progress": {
    "currentQuestion": 2,
    "timeLeft": 1800,
    "answeredCount": 3
  },
  "answers": [0, [1,2], -1, 2],
  "lastSaved": "2025-01-14T10:30:00.000Z"
}
```

## 安全特性

### 防作弊机制
1. **服务端时间权威**: 所有超时判断以服务端时间为准
2. **状态验证**: 每次保存都验证考试状态有效性
3. **自动提交**: 超时后无法继续答题，自动计算得分

### 数据完整性
1. **双重保存**: 本地和服务端同时保存，确保数据不丢失
2. **增量同步**: 只同步变化的数据，减少网络负担
3. **状态恢复**: 支持从本地或服务端恢复考试状态

## 用户体验优化

### 保存状态提示
- **保存中**: 显示"正在保存..."
- **已保存**: 显示"已保存"图标
- **保存失败**: 显示警告，但不阻止考试继续

### 网络异常处理
- **网络断开**: 继续使用本地保存，网络恢复后同步
- **服务端错误**: 显示错误提示，保持本地数据完整
- **超时处理**: 温和提示并自动跳转，避免数据丢失

## 实施效果

1. **提高可靠性**: 即使在网络不稳定环境下也能正常进行考试
2. **确保公平性**: 服务端统一控制考试时间，防止时间作弊
3. **改善体验**: 自动保存减少了考生对数据丢失的担忧
4. **便于管理**: 管理员可以看到更准确的考试进度和时间统计

## 注意事项

1. **时间同步**: 确保服务器时间准确，建议使用NTP同步
2. **存储容量**: 服务端保存会增加数据库负担，建议定期清理过期数据
3. **网络优化**: 对于网络环境较差的用户，适当增加保存间隔
4. **浏览器兼容**: localStorage在隐私模式下可能受限，需要适当提示用户
